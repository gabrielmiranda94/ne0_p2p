<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ne0_p2p - Ofertas P2P de Bitcoin</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header>
    <h1>ne0_p2p</h1>
    <p>As melhores ofertas P2P com desconto nas taxas!</p>
</header>

<main>
    <div class="filters">
        <div>
            <label for="country">País:</label>
            <select id="country">
                <option value="PT" {% if selected_country == 'PT' %}selected{% endif %}>Portugal</option>
                <option value="BR" {% if selected_country == 'BR' %}selected{% endif %}>Brasil</option>
                <option value="US" {% if selected_country == 'US' %}selected{% endif %}>Estados Unidos</option>
            </select>
        </div>
        <div>
            <label for="payment_method">Método de Pagamento:</label>
            <input type="text" id="payment_method" placeholder="Ex: mbway, revolut...">
        </div>
    </div>

    <div class="info-box">
        <p><strong>Dica:</strong> Use os nossos links para obter um <strong>desconto permanente</strong> nas taxas da Hodl Hodl (de 0.5% para 0.45%)!</p>
    </div>

    <div id="offers-container" class="offers-container">
        <!-- A tabela será preenchida dinamicamente pelo JavaScript -->
        <div id="loader" class="loader" style="display: none;"></div>
        <table>
            <thead>
            <tr>
                <th>Trader</th>
                <th>Reputação</th>
                <th>Preço</th>
                <th>Limites</th>
                <th>Método de Pagamento</th>
                <th>Ação</th>
            </tr>
            </thead>
            <tbody id="offers-tbody">
            {% for offer in offers %}
            <tr>
                <td>{{ offer.trader_username }}</td>
                <td>{{ "%.2f"|format(offer.trader_rating) }} ★</td>
                <td>{{ offer.price }} {{ offer.title.split(' ')[-1] }}</td>
                <td>{{ offer.min_amount }} - {{ offer.max_amount }}</td>
                <td>{{ offer.payment_method }}</td>
                <td><a href="{{ offer.affiliate_link }}" target="_blank" class="button">Comprar</a></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <p id="no-offers-message" class="no-offers" style="display: {% if not offers %}block{% else %}none{% endif %};">Nenhuma oferta encontrada para a seleção atual.</p>
    </div>
</main>

<footer>
    <p>&copy; {{ "now"|strftime("%Y") }} ne0_p2p - Encontre as melhores ofertas e poupe.</p>
</footer>

<script>
    const countrySelect = document.getElementById('country');
    const paymentMethodInput = document.getElementById('payment_method');
    const offersTbody = document.getElementById('offers-tbody');
    const noOffersMessage = document.getElementById('no-offers-message');
    const loader = document.getElementById('loader');

    let debounceTimer;

    async function fetchOffers() {
        const country = countrySelect.value;
        const paymentMethod = paymentMethodInput.value.trim();

        // Mostra o loader e limpa a tabela
        loader.style.display = 'block';
        offersTbody.innerHTML = '';
        noOffersMessage.style.display = 'none';

        let url = `/api/offers?country_code=${country}`;
        if (paymentMethod) {
            url += `&payment_method=${paymentMethod}`;
        }

        try {
            const response = await fetch(url);
            const offers = await response.json();

            if (offers.length === 0) {
                noOffersMessage.style.display = 'block';
            } else {
                offers.forEach(offer => {
                    const row = offersTbody.insertRow();
                    row.innerHTML = `
                            <td>${offer.trader_username}</td>
                            <td>${offer.trader_rating.toFixed(2)} ★</td>
                            <td>${offer.price} ${offer.title.split(' ').pop()}</td>
                            <td>${offer.min_amount} - ${offer.max_amount}</td>
                            <td>${offer.payment_method}</td>
                            <td><a href="${offer.affiliate_link}" target="_blank" class="button">Comprar</a></td>
                        `;
                });
            }
        } catch (error) {
            noOffersMessage.innerText = 'Erro ao carregar as ofertas. Tente novamente.';
            noOffersMessage.style.display = 'block';
        } finally {
            // Esconde o loader
            loader.style.display = 'none';
        }
    }

    countrySelect.addEventListener('change', fetchOffers);

    paymentMethodInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        // Espera 500ms depois que o usuário para de digitar para fazer a busca
        debounceTimer = setTimeout(fetchOffers, 500);
    });
</script>
</body>
</html>