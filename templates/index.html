<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ne0_p2p - Ofertas P2P de Bitcoin</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header>
    <h1>ne0_p2p</h1>
    <p>As melhores ofertas P2P com desconto nas taxas!</p>
</header>

<main>
    <div class="filters">
        <div class="side-selector">
            <!-- Se o utilizador quer comprar BTC, ele procura ofertas de 'SELL' -->
            <button id="side-sell" class="side-button {% if selected_side == 'SELL' %}active{% endif %}" data-side="SELL">Quero Comprar</button>
            <!-- Se o utilizador quer vender BTC, ele procura ofertas de 'BUY' -->
            <button id="side-buy" class="side-button {% if selected_side == 'BUY' %}active{% endif %}" data-side="BUY">Quero Vender</button>
        </div>
        <div>
            <label for="country">País:</label>
            <select id="country">
                <option value="PT" {% if selected_country == 'PT' %}selected{% endif %}>Portugal</option>
                <option value="BR" {% if selected_country == 'BR' %}selected{% endif %}>Brasil</option>
                <option value="US" {% if selected_country == 'US' %}selected{% endif %}>Estados Unidos</option>
            </select>
        </div>
        <div>
            <label for="payment_method">Método de Pagamento:</label>
            <input type="text" id="payment_method" placeholder="Ex: mbway, revolut, pix...">
        </div>
    </div>

    <div class="info-box">
        <p><strong>Dica:</strong> Use os nossos links para obter um <strong>desconto permanente</strong> nas taxas da Hodl Hodl (de 0.5% para 0.45%)!</p>
    </div>

    <div id="offers-container" class="offers-container">
        <div id="loader" class="loader"></div>
        <table>
            <thead>
            <tr>
                <th>Trader</th>
                <th>Reputação</th>
                <th>Preço Oferta</th>
                <th>Preço Mercado</th>
                <th>Prémio</th>
                <th>Limites</th>
                <th>Método de Pagamento</th>
                <th>Ação</th>
            </tr>
            </thead>
            <tbody id="offers-tbody">
            <!-- O conteúdo é carregado dinamicamente pelo JavaScript -->
            </tbody>
        </table>
        <p id="no-offers-message" class="no-offers">Nenhuma oferta encontrada para a seleção atual.</p>
    </div>
</main>

<footer>
    <p>&copy; {{ current_year }} ne0_p2p - Encontre as melhores ofertas e poupe.</p>
</footer>

<script>
    // --- SELETORES DE ELEMENTOS ---
    const countrySelect = document.getElementById('country');
    const paymentMethodInput = document.getElementById('payment_method');
    const offersTbody = document.getElementById('offers-tbody');
    const noOffersMessage = document.getElementById('no-offers-message');
    const loader = document.getElementById('loader');
    const sideSellButton = document.getElementById('side-sell');
    const sideBuyButton = document.getElementById('side-buy');

    let debounceTimer;
    // Pega o valor inicial do servidor para saber qual botão está ativo
    let currentSide = '{{ selected_side }}';

    // --- FUNÇÕES HELPER PARA FORMATAR DADOS ---
    function getPremiumClass(premium) {
        if (premium === null || premium === undefined) return 'premium-neutral';
        if (premium < 1) return 'premium-good'; // Prémio abaixo de 1% é bom
        if (premium > 5) return 'premium-bad';  // Prémio acima de 5% é mau
        return 'premium-neutral';
    }

    function formatCurrency(value, currency) {
        if (value === null || value === undefined) return 'N/A';
        // Garante que o valor é um número antes de formatar
        const numericValue = typeof value === 'string' ? parseFloat(value.replace(',', '')) : value;
        return `${numericValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${currency}`;
    }

    function formatPremium(premium) {
        if (premium === null || premium === undefined) return 'N/A';
        return `${premium.toFixed(2)}%`;
    }

    // --- LÓGICA PRINCIPAL DE BUSCA ---
    async function fetchOffers() {
        const country = countrySelect.value;
        const paymentMethod = paymentMethodInput.value.trim();

        loader.style.display = 'block';
        offersTbody.innerHTML = '';
        noOffersMessage.style.display = 'none';

        let url = `/api/offers?country_code=${country}&side=${currentSide}`;
        if (paymentMethod) {
            url += `&payment_method=${paymentMethod}`;
        }

        try {
            const response = await fetch(url);
            const offers = await response.json();

            if (offers.length === 0) {
                noOffersMessage.style.display = 'block';
            } else {
                offers.forEach(offer => {
                    const currency = offer.title.split(' ').pop();
                    const row = offersTbody.insertRow();
                    row.innerHTML = `
                            <td>${offer.trader_username}</td>
                            <td>${offer.trader_rating.toFixed(2)} ★</td>
                            <td>${formatCurrency(offer.price, currency)}</td>
                            <td>${formatCurrency(offer.market_price, currency)}</td>
                            <td><span class="${getPremiumClass(offer.premium)}">${formatPremium(offer.premium)}</span></td>
                            <td>${offer.min_amount} - ${offer.max_amount}</td>
                            <td>${offer.payment_method}</td>
                            <td><a href="${offer.affiliate_link}" target="_blank" class="button">Ver Oferta</a></td>
                        `;
                });
            }
        } catch (error) {
            console.error("Erro ao buscar ofertas:", error);
            noOffersMessage.innerText = 'Erro ao carregar as ofertas. Tente novamente.';
            noOffersMessage.style.display = 'block';
        } finally {
            loader.style.display = 'none';
        }
    }

    // --- EVENT LISTENERS ---
    function handleSideClick(event) {
        currentSide = event.target.dataset.side;

        sideSellButton.classList.remove('active');
        sideBuyButton.classList.remove('active');
        event.target.classList.add('active');

        fetchOffers(); // Busca as novas ofertas
    }

    sideSellButton.addEventListener('click', handleSideClick);
    sideBuyButton.addEventListener('click', handleSideClick);

    countrySelect.addEventListener('change', fetchOffers);

    paymentMethodInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fetchOffers, 500);
    });

    // Carrega os dados iniciais quando a página é totalmente carregada
    document.addEventListener('DOMContentLoaded', fetchOffers);
</script>
</body>
</html>