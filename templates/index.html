<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ne0_p2p - Ofertas P2P de Bitcoin</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header>
    <h1>ne0_p2p</h1>
    <p>As melhores ofertas P2P com desconto nas taxas!</p>
</header>

<main>
    <div class="filters">
        <div>
            <label for="country">País:</label>
            <select id="country">
                <option value="PT" {% if selected_country == 'PT' %}selected{% endif %}>Portugal</option>
                <option value="BR" {% if selected_country == 'BR' %}selected{% endif %}>Brasil</option>
                <option value="US" {% if selected_country == 'US' %}selected{% endif %}>Estados Unidos</option>
            </select>
        </div>
        <div>
            <label for="payment_method">Método de Pagamento:</label>
            <input type="text" id="payment_method" placeholder="Ex: mbway, revolut, pix...">
        </div>
    </div>

    <div class="info-box">
        <p><strong>Dica:</strong> Use os nossos links para obter um <strong>desconto permanente</strong> nas taxas da Hodl Hodl (de 0.5% para 0.45%)!</p>
    </div>

    <div id="offers-container" class="offers-container">
        <div id="loader" class="loader" style="display: none;"></div>
        <table>
            <thead>
            <tr>
                <th>Trader</th>
                <th>Reputação</th>
                <th>Preço Oferta</th>
                <th>Preço Mercado</th>
                <th>Prémio</th>
                <th>Limites</th>
                <th>Método de Pagamento</th>
                <th>Ação</th>
            </tr>
            </thead>
            <tbody id="offers-tbody">
            <!-- O conteúdo inicial é preenchido pelo servidor -->
            {% for offer in offers %}
            <tr>
                <td>{{ offer.trader_username }}</td>
                <td>{{ "%.2f"|format(offer.trader_rating) }} ★</td>
                <td>{{ offer.price }} {{ offer.title.split(' ')[-1] }}</td>
                <td>
                    {% if offer.market_price %}
                    {{ "%.2f"|format(offer.market_price) }} {{ offer.title.split(' ')[-1] }}
                    {% else %}
                    N/A
                    {% endif %}
                </td>
                <td>
                    {% if offer.premium is not none %}
                    <span class="
                                    {% if offer.premium < 1 %}premium-good
                                    {% elif offer.premium > 5 %}premium-bad
                                    {% else %}premium-neutral
                                    {% endif %}
                                ">{{ "%.2f"|format(offer.premium) }}%</span>
                    {% else %}
                    N/A
                    {% endif %}
                </td>
                <td>{{ offer.min_amount }} - {{ offer.max_amount }}</td>
                <td>{{ offer.payment_method }}</td>
                <td><a href="{{ offer.affiliate_link }}" target="_blank" class="button">Comprar</a></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <p id="no-offers-message" class="no-offers" style="display: {% if not offers %}block{% else %}none{% endif %};">Nenhuma oferta encontrada para a seleção atual.</p>
    </div>
</main>

<footer>
    <p>&copy; {{ current_year }} ne0_p2p - Encontre as melhores ofertas e poupe.</p>
</footer>

<script>
    const countrySelect = document.getElementById('country');
    const paymentMethodInput = document.getElementById('payment_method');
    const offersTbody = document.getElementById('offers-tbody');
    const noOffersMessage = document.getElementById('no-offers-message');
    const loader = document.getElementById('loader');

    let debounceTimer;

    // --- FUNÇÕES HELPER PARA FORMATAR DADOS ---
    function getPremiumClass(premium) {
        if (premium === null || premium === undefined) return 'premium-neutral';
        if (premium < 1) return 'premium-good'; // Prémio abaixo de 1% é bom
        if (premium > 5) return 'premium-bad';  // Prémio acima de 5% é mau
        return 'premium-neutral';
    }

    function formatCurrency(value, currency) {
        if (value === null || value === undefined) return 'N/A';
        return `${parseFloat(value).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${currency}`;
    }

    function formatPremium(premium) {
        if (premium === null || premium === undefined) return 'N/A';
        return `${premium.toFixed(2)}%`;
    }

    async function fetchOffers() {
        const country = countrySelect.value;
        const paymentMethod = paymentMethodInput.value.trim();

        loader.style.display = 'block';
        offersTbody.innerHTML = '';
        noOffersMessage.style.display = 'none';

        let url = `/api/offers?country_code=${country}`;
        if (paymentMethod) {
            url += `&payment_method=${paymentMethod}`;
        }

        try {
            const response = await fetch(url);
            const offers = await response.json();

            if (offers.length === 0) {
                noOffersMessage.style.display = 'block';
            } else {
                offers.forEach(offer => {
                    const currency = offer.title.split(' ').pop();
                    const row = offersTbody.insertRow();
                    row.innerHTML = `
                            <td>${offer.trader_username}</td>
                            <td>${offer.trader_rating.toFixed(2)} ★</td>
                            <td>${formatCurrency(offer.price.replace(',', ''), currency)}</td>
                            <td>${formatCurrency(offer.market_price, currency)}</td>
                            <td><span class="${getPremiumClass(offer.premium)}">${formatPremium(offer.premium)}</span></td>
                            <td>${offer.min_amount} - ${offer.max_amount}</td>
                            <td>${offer.payment_method}</td>
                            <td><a href="${offer.affiliate_link}" target="_blank" class="button">Comprar</a></td>
                        `;
                });
            }
        } catch (error) {
            noOffersMessage.innerText = 'Erro ao carregar as ofertas. Tente novamente.';
            noOffersMessage.style.display = 'block';
        } finally {
            loader.style.display = 'none';
        }
    }

    countrySelect.addEventListener('change', fetchOffers);
    paymentMethodInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fetchOffers, 500);
    });

    // Carregar as ofertas para o país selecionado quando a página abre pela primeira vez
    document.addEventListener('DOMContentLoaded', fetchOffers);
</script>
</body>
</html>