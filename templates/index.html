<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ne0_p2p - Ofertas P2P de Bitcoin</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header>
    <h1>ne0_p2p</h1>
    <p>As melhores ofertas P2P com desconto nas taxas!</p>
</header>

<main>
    <div class="filters">
        <div class="side-selector">
            <button id="side-sell" class="side-button" data-side="SELL">Quero Comprar</button>
            <button id="side-buy" class="side-button" data-side="BUY">Quero Vender</button>
        </div>
        <div>
            <label for="currency">Moeda:</label>
            <select id="currency">
                <option value="EUR">Euro (EUR)</option>
                <option value="BRL">Real (BRL)</option>
                <option value="USD">Dólar (USD)</option>
            </select>
        </div>
        <div>
            <label for="payment_method">Método de Pagamento:</label>
            <select id="payment_method">
                <option value="">Todos</option>
            </select>
        </div>
    </div>

    <div class="info-box">
        <p><strong>Dica:</strong> Use os nossos links para obter um <strong>desconto permanente</strong> nas taxas da Hodl Hodl (de 0.5% para 0.45%)!</p>
    </div>

    <div id="offers-container" class="offers-container">
        <div id="loader" class="loader"></div>
        <table>
            <thead>
            <tr>
                <th>Trader</th>
                <th>Reputação</th>
                <th>Preço Oferta</th>
                <th>Preço Mercado</th>
                <th>Prémio</th>
                <th>Limites</th>
                <th>Método de Pagamento</th>
                <th>País</th>
                <th>Ação</th>
            </tr>
            </thead>
            <tbody id="offers-tbody"></tbody>
        </table>
        <p id="no-offers-message" class="no-offers" style="display: none;">Nenhuma oferta encontrada para a seleção atual.</p>
    </div>
</main>

<footer>
    <p>&copy; 2025 ne0_p2p - Encontre as melhores ofertas e poupe.</p>
</footer>

<script>
    const currencySelect = document.getElementById('currency');
    const paymentMethodSelect = document.getElementById('payment_method');
    const offersTbody = document.getElementById('offers-tbody');
    const noOffersMessage = document.getElementById('no-offers-message');
    const loader = document.getElementById('loader');
    const sideSellButton = document.getElementById('side-sell');
    const sideBuyButton = document.getElementById('side-buy');

    let currentSide;

    async function populatePaymentMethods() {
        try {
            // Chama o endpoint simplificado, sem parâmetros
            const response = await fetch('/api/payment-methods');
            if (!response.ok) return;

            const methods = await response.json();

            methods.sort((a, b) => (a.type || '').localeCompare(b.type || '') || (a.name || '').localeCompare(b.name));

            let currentGroup = "";
            methods.forEach(method => {
                if (!method.name) return; // Ignora métodos sem nome

                if (method.type !== currentGroup) {
                    const group = document.createElement('optgroup');
                    group.label = method.type || 'Outros';
                    paymentMethodSelect.appendChild(group);
                    currentGroup = method.type || 'Outros';
                }
                const option = document.createElement('option');
                option.value = method.name;
                option.textContent = method.name;
                paymentMethodSelect.querySelector(`optgroup[label="${currentGroup}"]`).appendChild(option);
            });
        } catch (error) {
            console.error("Erro ao popular métodos de pagamento:", error);
        }
    }


    function getPremiumClass(premium) { /* ... (sem alteração) */ }
    function formatCurrency(value, currency) { /* ... (sem alteração) */ }
    function formatPremium(premium) { /* ... (sem alteração) */ }

    async function fetchOffers() {
        const currency = currencySelect.value;
        const paymentMethod = paymentMethodSelect.value;

        loader.style.display = 'block';
        offersTbody.innerHTML = '';
        noOffersMessage.style.display = 'none';

        let url = `/api/offers?currency_code=${currency}&side=${currentSide}`;
        if (paymentMethod) {
            url += `&payment_method=${paymentMethod}`;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const offers = await response.json();

            if (offers.length === 0) {
                noOffersMessage.style.display = 'block';
            } else {
                offers.forEach(offer => {
                    const row = offersTbody.insertRow();
                    row.innerHTML = `
                        <td>${offer.trader_username || 'N/A'}</td>
                        <td>${(offer.trader_rating || 0).toFixed(2)} ★</td>
                        <td>${formatCurrency(offer.price, currency)}</td>
                        <td>${formatCurrency(offer.market_price, currency)}</td>
                        <td><span class="${getPremiumClass(offer.premium)}">${formatPremium(offer.premium)}</span></td>
                        <td>${offer.min_amount || 'N/A'} - ${offer.max_amount || 'N/A'}</td>
                        <td>${offer.payment_method_name || 'N/A'}</td>
                        <td>${offer.country || 'Global'}</td>
                        <td><a href="${offer.affiliate_link}" target="_blank" class="button">Ver Oferta</a></td>
                    `;
                });
            }
        } catch (error) {
            console.error("Erro ao renderizar ofertas:", error);
            noOffersMessage.innerText = 'Erro ao exibir as ofertas.';
            noOffersMessage.style.display = 'block';
        } finally {
            loader.style.display = 'none';
        }
    }

    function handleSideClick(event) {
        currentSide = event.target.dataset.side;
        sideSellButton.classList.toggle('active', currentSide === 'SELL');
        sideBuyButton.classList.toggle('active', currentSide === 'BUY');
        fetchOffers();
    }

    sideSellButton.addEventListener('click', handleSideClick);
    sideBuyButton.addEventListener('click', handleSideClick);
    currencySelect.addEventListener('change', fetchOffers); // Simplificado
    paymentMethodSelect.addEventListener('change', fetchOffers);

    document.addEventListener('DOMContentLoaded', async () => {
        // As ações agora são sequenciais e mais simples
        await populatePaymentMethods();

        currencySelect.value = 'EUR';
        currentSide = 'SELL';
        sideSellButton.classList.add('active');
        sideBuyButton.classList.remove('active');

        await fetchOffers();
    });
</script>
</body>
</html>