<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ne0_p2p - Ofertas P2P de Bitcoin</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header>
    <h1>ne0_p2p</h1>
    <p>As melhores ofertas P2P com desconto nas taxas!</p>
</header>

<main>
    <div class="filters">
        <div class="side-selector">
            <button id="side-sell" class="side-button" data-side="SELL">Quero Comprar</button>
            <button id="side-buy" class="side-button" data-side="BUY">Quero Vender</button>
        </div>
        <div>
            <label for="currency">Moeda:</label>
            <select id="currency">
                <option value="EUR">Euro (EUR)</option>
                <option value="BRL">Real (BRL)</option>
                <option value="USD">Dólar (USD)</option>
            </select>
        </div>
        <div>
            <label for="payment_method">Método de Pagamento:</label>
            <input type="text" id="payment_method" placeholder="Ex: Revolut, PIX...">
        </div>
    </div>

    <div class="info-box">
        <p><strong>Dica:</strong> Use os nossos links para obter um <strong>desconto permanente</strong> nas taxas da Hodl Hodl (de 0.5% para 0.45%)!</p>
    </div>

    <div id="offers-container" class="offers-container">
        <div id="loader" class="loader"></div>
        <table>
            <thead>
            <tr>
                <th>Trader</th>
                <th>Reputação</th>
                <th>Preço Oferta</th>
                <th>Preço Mercado</th>
                <th>Prémio</th>
                <th>Limites</th>
                <th>Método de Pagamento</th>
                <th>País</th>
                <th>Ação</th>
            </tr>
            </thead>
            <tbody id="offers-tbody"></tbody>
        </table>
        <p id="no-offers-message" class="no-offers" style="display: none;">Nenhuma oferta encontrada para a seleção atual.</p>
    </div>
</main>

<footer>
    <p>&copy; 2025 ne0_p2p - Encontre as melhores ofertas e poupe.</p>
</footer>

<script>
    const currencySelect = document.getElementById('currency');
    const paymentMethodInput = document.getElementById('payment_method');
    const offersTbody = document.getElementById('offers-tbody');
    const noOffersMessage = document.getElementById('no-offers-message');
    const loader = document.getElementById('loader');
    const sideSellButton = document.getElementById('side-sell');
    const sideBuyButton = document.getElementById('side-buy');

    let debounceTimer;
    let currentSide;

    function getPremiumClass(premium) {
        if (premium === null || premium === undefined) return 'premium-neutral';
        if (premium < 1) return 'premium-good';
        if (premium > 5) return 'premium-bad';
        return 'premium-neutral';
    }

    function formatCurrency(value, currency) {
        if (value === null || value === undefined || !currency) return 'N/A';
        const numericValue = typeof value === 'string' ? parseFloat(value.replace(',', '')) : value;
        return `${numericValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${currency}`;
    }

    function formatPremium(premium) {
        if (premium === null || premium === undefined) return 'N/A';
        return `${premium.toFixed(2)}%`;
    }

    async function fetchOffers() {
        const currency = currencySelect.value;
        const paymentMethod = paymentMethodInput.value.trim();

        loader.style.display = 'block';
        offersTbody.innerHTML = '';
        noOffersMessage.style.display = 'none';

        let url = `/api/offers?currency_code=${currency}&side=${currentSide}`;
        if (paymentMethod) {
            url += `&payment_method=${paymentMethod}`;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const offers = await response.json();

            if (offers.length === 0) {
                noOffersMessage.style.display = 'block';
            } else {
                offers.forEach(offer => {
                    const row = offersTbody.insertRow();
                    // ESTAS LINHAS ESTÃO CORRIGIDAS PARA CORRESPONDER AO JSON
                    row.innerHTML = `
                        <td>${offer.trader_username || 'N/A'}</td>
                        <td>${(offer.trader_rating || 0).toFixed(2)} ★</td>
                        <td>${formatCurrency(offer.price, currency)}</td>
                        <td>${formatCurrency(offer.market_price, currency)}</td>
                        <td><span class="${getPremiumClass(offer.premium)}">${formatPremium(offer.premium)}</span></td>
                        <td>${offer.min_amount || 'N/A'} - ${offer.max_amount || 'N/A'}</td>
                        <td>${offer.payment_method_name || 'N/A'}</td>
                        <td>${offer.country || 'Global'}</td>
                        <td><a href="${offer.affiliate_link}" target="_blank" class="button">Ver Oferta</a></td>
                    `;
                });
            }
        } catch (error) {
            console.error("Erro ao renderizar ofertas:", error);
            noOffersMessage.innerText = 'Erro ao exibir as ofertas.';
            noOffersMessage.style.display = 'block';
        } finally {
            loader.style.display = 'none';
        }
    }

    function handleSideClick(event) {
        currentSide = event.target.dataset.side;
        sideSellButton.classList.toggle('active', currentSide === 'SELL');
        sideBuyButton.classList.toggle('active', currentSide === 'BUY');
        fetchOffers();
    }

    sideSellButton.addEventListener('click', handleSideClick);
    sideBuyButton.addEventListener('click', handleSideClick);
    currencySelect.addEventListener('change', fetchOffers);
    paymentMethodInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fetchOffers, 500);
    });

    document.addEventListener('DOMContentLoaded', () => {
        currencySelect.value = 'EUR';
        currentSide = 'SELL';
        sideSellButton.classList.add('active');
        sideBuyButton.classList.remove('active');
        fetchOffers();
    });
</script>
</body>
</html>